{% extends 'base.html' %}
{% block title %}{% if is_edit %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å{% else %}–°–æ–∑–¥–∞—Ç—å{% endif %} —Å–æ–±—ã—Ç–∏–µ{% endblock %}
{% block content %}
  <h1>{% if is_edit %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å{% else %}–°–æ–∑–¥–∞—Ç—å{% endif %} —Å–æ–±—ã—Ç–∏–µ</h1>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <fieldset>
      <legend>–û—Å–Ω–æ–≤–Ω–æ–µ</legend>
      {{ form.as_p }}

      <!-- === –ë–ª–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ YandexGPT === -->
      <button type="button" class="btn btn-outline-secondary" id="ai-generate-btn" style="margin-top:6px;">
        ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ (–ò–ò)
      </button>
      <small id="ai-hint" style="display:block;color:#666;margin-top:4px;">
        –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è, –¥–∞—Ç—ã, –º–µ—Å—Ç–∞ –∏ –≤–∞—à–∏—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤.
      </small>
      <!-- ============================================= -->
    </fieldset>

    <fieldset>
      <legend>–¢–∞—Ä–∏—Ñ—ã</legend>
      {{ formset.management_form }}

      <div id="tariffs-container">
        {% for f in formset.forms %}
          <div class="tariff-item" style="border:1px solid #ddd; padding:10px; margin:8px 0;">
            {{ f.as_p }}
            {% if f.instance.pk %}
              <p><label>{{ f.DELETE }} –£–¥–∞–ª–∏—Ç—å</label></p>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <button type="button" id="add-tariff">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button>
      <p><em>–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞—Ä–∏—Ñ–æ–≤, —Ü–µ–Ω–∞ –∏ –∫–≤–æ—Ç—ã –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ.</em></p>
    </fieldset>

    <button type="submit" name="save_draft">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</button>
    <button type="submit" name="submit_for_moderation">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é</button>
  </form>

  <!-- === JS –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–æ–≤ === -->
  <script>
  (function() {
    const container = document.getElementById('tariffs-container');
    const addBtn = document.getElementById('add-tariff');
    const totalFormsInput = document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS');
    const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`;

    addBtn.addEventListener('click', function() {
      const formIndex = parseInt(totalFormsInput.value, 10);
      const html = emptyFormHtml.replaceAll('__prefix__', formIndex);
      const wrapper = document.createElement('div');
      wrapper.className = 'tariff-item';
      wrapper.style.cssText = 'border:1px solid #ddd; padding:10px; margin:8px 0;';
      wrapper.innerHTML = html;
      container.appendChild(wrapper);
      totalFormsInput.value = formIndex + 1;
    });
  })();
  </script>

  <!-- === –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç YandexGPT === -->
  {% load static %}
  <script defer src="{% static 'js/ai_description.js' %}"></script>

{% endblock %}
